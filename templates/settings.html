{% extends 'layout.html' %}
{% block content %}
<style>
.settings-container { max-width: 900px; margin: 0 auto; }
.nav-tabs { border-bottom: 2px solid #e9ecef; margin-bottom: 1.5rem; }
.nav-tabs .nav-link { border: none; color: #6c757d; font-weight: 500; padding: 0.75rem 1.25rem; margin-right: 0.5rem; }
.nav-tabs .nav-link:hover { color: #495057; border: none; }
.nav-tabs .nav-link.active { color: #0d6efd; border-bottom: 2px solid #0d6efd; background: transparent; }
.settings-card { background: #fff; border-radius: 12px; border: 1px solid #e9ecef; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
.settings-section { padding: 1.5rem; }
.settings-section + .settings-section { border-top: 1px solid #e9ecef; }
.provider-pills { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.provider-pill { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 50px; border: 1px solid #dee2e6; cursor: pointer; transition: all 0.2s; background: #fff; font-size: 0.875rem; }
.provider-pill:hover { border-color: #0d6efd; background: #f8f9fa; }
.provider-pill.active { border-color: #0d6efd; background: #0d6efd; color: #fff; }
.provider-pill.active img { filter: brightness(0) invert(1); }
.provider-pill input { display: none; }
.model-picker { display: flex; gap: 0.5rem; align-items: center; }
.api-key-input { background: #f8f9fa; border: 1px solid #e9ecef; }
.feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
.feature-card { padding: 1rem; border-radius: 8px; border: 1px solid #e9ecef; }
.feature-card h6 { font-size: 0.875rem; margin-bottom: 0.75rem; color: #495057; }
.toggle-group { display: flex; flex-direction: column; gap: 0.75rem; }
.compact-form-group { margin-bottom: 1rem; }
.compact-form-group:last-child { margin-bottom: 0; }
.save-bar { position: sticky; bottom: 0; background: #fff; border-top: 1px solid #e9ecef; padding: 1rem 1.5rem; display: flex; justify-content: flex-end; gap: 1rem; z-index: 100; }
.model-cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75rem; margin-top: 0.75rem; }
.model-card { padding: 0.75rem; border-radius: 8px; border: 1px solid #e9ecef; cursor: pointer; transition: all 0.2s; background: #fff; }
.model-card:hover { border-color: #0d6efd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
.model-card-selected { border-color: #0d6efd; background: #f0f7ff; }
.model-card-name { font-weight: 500; font-size: 0.875rem; margin-bottom: 0.25rem; }
.model-card-meta { font-size: 0.75rem; color: #6c757d; }
.model-card-badges { display: flex; gap: 0.25rem; margin-top: 0.5rem; flex-wrap: wrap; }
.model-badge { font-size: 0.625rem; padding: 0.125rem 0.375rem; border-radius: 4px; text-transform: uppercase; font-weight: 600; }
.model-badge-vision { background: #d1ecf1; color: #0c5460; }
.model-badge-reasoning { background: #fff3cd; color: #856404; }
.model-badge-tools { background: #d4edda; color: #155724; }
.model-card-skeleton { height: 70px; border-radius: 8px; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
@keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
.shimmer-text { background: linear-gradient(90deg, #6c757d 0%, #adb5bd 50%, #6c757d 100%); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shimmer-text 2s linear infinite; }
@keyframes shimmer-text { to { background-position: 200% center; } }
.shimmer-text-small { font-size: 0.75rem; }
.collapse-toggle { cursor: pointer; user-select: none; }
.collapse-toggle i { transition: transform 0.2s; }
.collapse-toggle[aria-expanded="true"] i { transform: rotate(180deg); }
</style>

<div class="settings-container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h4 mb-0">Settings</h1>
    <button type="submit" form="settingsForm" class="btn btn-primary">
      <i class="bi bi-check-lg"></i> Save Changes
    </button>
  </div>

  <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai-panel" type="button" role="tab">
        <i class="bi bi-magic"></i> AI Assistant
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="captcha-tab" data-bs-toggle="tab" data-bs-target="#captcha-panel" type="button" role="tab">
        <i class="bi bi-shield-check"></i> Captcha
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="general-tab" data-bs-toggle="tab" data-bs-target="#general-panel" type="button" role="tab">
        <i class="bi bi-gear"></i> General
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account-panel" type="button" role="tab">
        <i class="bi bi-person"></i> Account
      </button>
    </li>
  </ul>

  <form method="POST" id="settingsForm">
    <div class="tab-content" id="settingsTabContent">
      
      <!-- AI Assistant Tab -->
      <div class="tab-pane fade show active" id="ai-panel" role="tabpanel">
        <div class="settings-card">
          <!-- Shared Keys (Collapsed) -->
          <div class="settings-section">
            <div class="d-flex align-items-center justify-content-between collapse-toggle" data-bs-toggle="collapse" data-bs-target="#sharedKeysBody" aria-expanded="false">
              <h6 class="mb-0"><i class="bi bi-key"></i> Shared API Keys</h6>
              <i class="bi bi-chevron-down"></i>
            </div>
            <div class="collapse" id="sharedKeysBody">
              <p class="text-muted small mt-2 mb-3">Fallback keys used when provider-specific keys aren't set.</p>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label small text-muted">OpenAI</label>
                  <input type="password" name="shared_openai_api_key" class="form-control form-control-sm api-key-input" value="{{ shared_openai_api_key }}" placeholder="sk-...">
                </div>
                <div class="col-md-6">
                  <label class="form-label small text-muted">OpenRouter</label>
                  <input type="password" name="shared_openrouter_api_key" class="form-control form-control-sm api-key-input" value="{{ shared_openrouter_api_key }}" placeholder="sk-or-...">
                </div>
                <div class="col-md-6">
                  <label class="form-label small text-muted">Google AI</label>
                  <input type="password" name="shared_google_api_key" class="form-control form-control-sm api-key-input" value="{{ shared_google_api_key }}" placeholder="AIza...">
                </div>
                <div class="col-md-6">
                  <label class="form-label small text-muted">Poe</label>
                  <input type="password" name="shared_poe_api_key" class="form-control form-control-sm api-key-input" value="{{ shared_poe_api_key }}" placeholder="poe-...">
                </div>
              </div>
            </div>
          </div>

          <!-- Drafting AI -->
          <div class="settings-section">
            <h6 class="mb-3"><i class="bi bi-pen"></i> Drafting AI</h6>
            
            <div class="compact-form-group">
              <label class="form-label small text-muted">Provider</label>
              <div class="provider-pills" id="draftProviderSelector">
                <label class="provider-pill {% if draft_ai_provider == 'openai' or not draft_ai_provider %}active{% endif %}">
                  <input type="radio" name="draft_ai_provider" value="openai" {% if draft_ai_provider == 'openai' or not draft_ai_provider %}checked{% endif %} onchange="handleDraftProviderChange()">
                  <img src="https://models.dev/logos/openai.svg" alt="" width="16" height="16">
                  <span>OpenAI</span>
                </label>
                <label class="provider-pill {% if draft_ai_provider == 'openrouter' %}active{% endif %}">
                  <input type="radio" name="draft_ai_provider" value="openrouter" {% if draft_ai_provider == 'openrouter' %}checked{% endif %} onchange="handleDraftProviderChange()">
                  <img src="https://models.dev/logos/openrouter.svg" alt="" width="16" height="16">
                  <span>OpenRouter</span>
                </label>
                <label class="provider-pill {% if draft_ai_provider == 'google' %}active{% endif %}">
                  <input type="radio" name="draft_ai_provider" value="google" {% if draft_ai_provider == 'google' %}checked{% endif %} onchange="handleDraftProviderChange()">
                  <img src="https://models.dev/logos/google.svg" alt="" width="16" height="16">
                  <span>Google</span>
                </label>
                <label class="provider-pill {% if draft_ai_provider == 'poe' %}active{% endif %}">
                  <input type="radio" name="draft_ai_provider" value="poe" {% if draft_ai_provider == 'poe' %}checked{% endif %} onchange="handleDraftProviderChange()">
                  <img src="https://models.dev/logos/poe.svg" alt="" width="16" height="16">
                  <span>Poe</span>
                </label>
              </div>
            </div>

            <div id="draftOpenaiKeySection" class="compact-form-group {% if draft_ai_provider != 'openai' and draft_ai_provider %}d-none{% endif %}">
              <label class="form-label small text-muted">API Key <span class="text-muted">(optional)</span></label>
              <input type="password" name="draft_openai_api_key" class="form-control form-control-sm api-key-input" value="{{ draft_openai_api_key }}" placeholder="Uses shared key if empty">
            </div>
            <div id="draftOpenrouterKeySection" class="compact-form-group {% if draft_ai_provider != 'openrouter' %}d-none{% endif %}">
              <label class="form-label small text-muted">API Key <span class="text-muted">(optional)</span></label>
              <input type="password" name="draft_openrouter_api_key" class="form-control form-control-sm api-key-input" value="{{ draft_openrouter_api_key }}" placeholder="Uses shared key if empty">
            </div>
            <div id="draftGoogleKeySection" class="compact-form-group {% if draft_ai_provider != 'google' %}d-none{% endif %}">
              <label class="form-label small text-muted">API Key <span class="text-muted">(optional)</span></label>
              <input type="password" name="draft_google_api_key" class="form-control form-control-sm api-key-input" value="{{ draft_google_api_key }}" placeholder="Uses shared key if empty">
            </div>
            <div id="draftPoeKeySection" class="{% if draft_ai_provider != 'poe' %}d-none{% endif %}">
              <div class="compact-form-group">
                <label class="form-label small text-muted">API Key <span class="text-muted">(optional)</span></label>
                <input type="password" name="draft_poe_api_key" class="form-control form-control-sm api-key-input" value="{{ draft_poe_api_key }}" placeholder="Uses shared key if empty">
              </div>
              <div class="compact-form-group">
                <label class="form-label small text-muted">Reasoning</label>
                <select name="draft_poe_reasoning_effort" class="form-select form-select-sm" style="max-width: 150px;">
                  <option value="none" {% if draft_poe_reasoning_effort == 'none' %}selected{% endif %}>None</option>
                  <option value="low" {% if draft_poe_reasoning_effort == 'low' %}selected{% endif %}>Low</option>
                  <option value="medium" {% if draft_poe_reasoning_effort == 'medium' %}selected{% endif %}>Medium</option>
                </select>
              </div>
            </div>

            <div class="compact-form-group">
              <label class="form-label small text-muted">Model</label>
              <div class="model-picker">
                <input list="draftModelList" name="draft_model" id="draftModelSelect" class="form-control form-control-sm" value="{{ draft_model }}" placeholder="Select or type model..." style="flex: 1;">
                <datalist id="draftModelList">
                  {% for model in draft_available_models %}
                  <option value="{{ model.id }}" label="{{ model.name }}">
                  {% endfor %}
                </datalist>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshDraftModels()" id="draftRefreshBtn">
                  <i class="bi bi-arrow-repeat"></i>
                </button>
              </div>
              <div class="form-text small text-muted" id="draftModelHelp">
                <span class="shimmer-text shimmer-text-small">Loading models...</span>
              </div>
              <div id="draftModelCards" class="model-cards-grid"></div>
            </div>

            <div class="compact-form-group">
              <label class="form-label small text-muted">Personality</label>
              <textarea name="agent_personality" class="form-control form-control-sm" rows="2" placeholder="How should the AI sound?">{{ agent_personality }}</textarea>
            </div>
          </div>

          <!-- Translation -->
          <div class="settings-section">
            <h6 class="mb-3"><i class="bi bi-translate"></i> Translation</h6>
            <div class="feature-grid">
              <div class="feature-card">
                <label class="form-label small text-muted">Provider</label>
                <select name="translation_provider" id="translationProvider" class="form-select form-select-sm" onchange="handleTranslationProviderChange()">
                  <option value="google" {% if translation_provider == 'google' or not translation_provider %}selected{% endif %}>Google Translate (Free)</option>
                  <option value="openai" {% if translation_provider == 'openai' %}selected{% endif %}>OpenAI</option>
                  <option value="openrouter" {% if translation_provider == 'openrouter' %}selected{% endif %}>OpenRouter</option>
                  <option value="google_ai" {% if translation_provider == 'google_ai' %}selected{% endif %}>Google AI</option>
                  <option value="poe" {% if translation_provider == 'poe' %}selected{% endif %}>Poe</option>
                </select>
              </div>
              <div class="feature-card" id="translationModelSection" {% if translation_provider == 'google' or not translation_provider %}style="display: none;"{% endif %}>
                <label class="form-label small text-muted">Model</label>
                <div class="input-group input-group-sm">
                  <input list="translationModelList" name="translation_model" id="translationModelSelect" class="form-control" value="{{ translation_model }}" placeholder="Default">
                  <datalist id="translationModelList">
                    {% for model in draft_available_models %}
                    <option value="{{ model.id }}" label="{{ model.name }}">
                    {% endfor %}
                  </datalist>
                  <button type="button" class="btn btn-outline-secondary" onclick="refreshTranslationModels()">
                    <i class="bi bi-arrow-repeat"></i>
                  </button>
                </div>
                <div class="form-text small text-muted" id="translationModelHelp">Uses drafting AI key</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Captcha Tab -->
      <div class="tab-pane fade" id="captcha-panel" role="tabpanel">
        <div class="settings-card">
          <div class="settings-section">
            <h6 class="mb-3"><i class="bi bi-shield-check"></i> Captcha Solver AI</h6>
            
            <div class="compact-form-group">
              <label class="form-label small text-muted">Provider</label>
              <div class="provider-pills" id="captchaProviderSelector">
                <label class="provider-pill {% if captcha_ai_provider == 'openai' or not captcha_ai_provider %}active{% endif %}">
                  <input type="radio" name="captcha_ai_provider" value="openai" {% if captcha_ai_provider == 'openai' or not captcha_ai_provider %}checked{% endif %} onchange="handleCaptchaProviderChange()">
                  <img src="https://models.dev/logos/openai.svg" alt="" width="16" height="16">
                  <span>OpenAI</span>
                </label>
                <label class="provider-pill {% if captcha_ai_provider == 'openrouter' %}active{% endif %}">
                  <input type="radio" name="captcha_ai_provider" value="openrouter" {% if captcha_ai_provider == 'openrouter' %}checked{% endif %} onchange="handleCaptchaProviderChange()">
                  <img src="https://models.dev/logos/openrouter.svg" alt="" width="16" height="16">
                  <span>OpenRouter</span>
                </label>
                <label class="provider-pill {% if captcha_ai_provider == 'google' %}active{% endif %}">
                  <input type="radio" name="captcha_ai_provider" value="google" {% if captcha_ai_provider == 'google' %}checked{% endif %} onchange="handleCaptchaProviderChange()">
                  <img src="https://models.dev/logos/google.svg" alt="" width="16" height="16">
                  <span>Google</span>
                </label>
                <label class="provider-pill {% if captcha_ai_provider == 'poe' %}active{% endif %}">
                  <input type="radio" name="captcha_ai_provider" value="poe" {% if captcha_ai_provider == 'poe' %}checked{% endif %} onchange="handleCaptchaProviderChange()">
                  <img src="https://models.dev/logos/poe.svg" alt="" width="16" height="16">
                  <span>Poe</span>
                </label>
              </div>
            </div>

            <div id="captchaOpenaiKeySection" class="compact-form-group {% if captcha_ai_provider != 'openai' and captcha_ai_provider %}d-none{% endif %}">
              <label class="form-label small text-muted">API Key <span class="text-muted">(optional)</span></label>
              <input type="password" name="captcha_openai_api_key" class="form-control form-control-sm api-key-input" value="{{ captcha_openai_api_key }}" placeholder="Uses shared key if empty">
            </div>
            <div id="captchaOpenrouterKeySection" class="compact-form-group {% if captcha_ai_provider != 'openrouter' %}d-none{% endif %}">
              <label class="form-label small text-muted">API Key <span class="text-muted">(optional)</span></label>
              <input type="password" name="captcha_openrouter_api_key" class="form-control form-control-sm api-key-input" value="{{ captcha_openrouter_api_key }}" placeholder="Uses shared key if empty">
            </div>
            <div id="captchaGoogleKeySection" class="compact-form-group {% if captcha_ai_provider != 'google' %}d-none{% endif %}">
              <label class="form-label small text-muted">API Key <span class="text-muted">(optional)</span></label>
              <input type="password" name="captcha_google_api_key" class="form-control form-control-sm api-key-input" value="{{ captcha_google_api_key }}" placeholder="Uses shared key if empty">
            </div>
            <div id="captchaPoeKeySection" class="{% if captcha_ai_provider != 'poe' %}d-none{% endif %}">
              <div class="compact-form-group">
                <label class="form-label small text-muted">API Key <span class="text-muted">(optional)</span></label>
                <input type="password" name="captcha_poe_api_key" class="form-control form-control-sm api-key-input" value="{{ captcha_poe_api_key }}" placeholder="Uses shared key if empty">
              </div>
              <div class="compact-form-group">
                <label class="form-label small text-muted">Reasoning</label>
                <select name="captcha_poe_reasoning_effort" class="form-select form-select-sm" style="max-width: 150px;">
                  <option value="none" {% if captcha_poe_reasoning_effort == 'none' %}selected{% endif %}>None</option>
                  <option value="low" {% if captcha_poe_reasoning_effort == 'low' %}selected{% endif %}>Low</option>
                  <option value="medium" {% if captcha_poe_reasoning_effort == 'medium' %}selected{% endif %}>Medium</option>
                </select>
              </div>
              <div class="alert alert-info py-2 small">
                <i class="bi bi-lightbulb"></i> GPT-5 Nano on Poe is best for captchas.
              </div>
            </div>

            <div class="compact-form-group">
              <label class="form-label small text-muted">Model</label>
              <div class="model-picker">
                <input list="captchaModelList" name="captcha_model" id="captchaModelSelect" class="form-control form-control-sm" value="{{ captcha_model }}" placeholder="Select or type model..." style="flex: 1;">
                <datalist id="captchaModelList">
                  {% for model in captcha_available_models %}
                  <option value="{{ model.id }}" label="{{ model.name }}">
                  {% endfor %}
                </datalist>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshCaptchaModels()" id="captchaRefreshBtn">
                  <i class="bi bi-arrow-repeat"></i>
                </button>
              </div>
              <div class="form-text small text-muted" id="captchaModelHelp">
                <span class="shimmer-text shimmer-text-small">Loading models...</span>
              </div>
              <div id="captchaModelCards" class="model-cards-grid"></div>
            </div>

            <div class="toggle-group mt-4">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="auto_solve_captcha" id="auto_solve_captcha" {% if auto_solve_captcha %}checked{% endif %}>
                <label class="form-check-label small" for="auto_solve_captcha">Auto-solve challenges</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="captcha_preprocessing" id="captcha_preprocessing" {% if captcha_preprocessing is not defined or captcha_preprocessing %}checked{% endif %}>
                <label class="form-check-label small" for="captcha_preprocessing">Pre-process challenge text <span class="badge bg-warning text-dark">Beta</span></label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- General Tab -->
      <div class="tab-pane fade" id="general-panel" role="tabpanel">
        <div class="settings-card">
          <div class="settings-section">
            <h6 class="mb-3"><i class="bi bi-gear"></i> Preferences</h6>
            <div class="toggle-group">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="use_easymde" id="use_easymde" {% if use_easymde %}checked{% endif %}>
                <label class="form-check-label" for="use_easymde">
                  <div>Enable Markdown Editor</div>
                  <div class="form-text">Use EasyMDE for rich text editing</div>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Account Tab -->
      <div class="tab-pane fade" id="account-panel" role="tabpanel">
        <div class="settings-card">
          <div class="settings-section">
            <h6 class="mb-3"><i class="bi bi-person-lock"></i> Privacy</h6>
            <p class="text-muted small mb-3">Your Moltbook API Key is stored in your browser's local storage.</p>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearLocalStorage()">
              <i class="bi bi-box-arrow-right"></i> Log out and clear data
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
let currentVerificationCode = null;
let currentTaskId = null;

/* ── Provider logo map ── */
const PROVIDER_LOGOS = {
    openai: 'https://models.dev/logos/openai.svg',
    openrouter: 'https://models.dev/logos/openrouter.svg',
    google: 'https://models.dev/logos/google.svg',
    poe: 'https://models.dev/logos/poe.svg',
    anthropic: 'https://models.dev/logos/anthropic.svg',
    meta: 'https://models.dev/logos/meta.svg',
    mistral: 'https://models.dev/logos/mistralai.svg',
};

/* ── Provider change handlers ── */
function handleDraftProviderChange() {
    const provider = document.querySelector('input[name="draft_ai_provider"]:checked').value;

    document.querySelectorAll('#draftProviderSelector .provider-pill').forEach(el => {
        el.classList.toggle('active', el.querySelector('input').value === provider);
    });

    ['draftOpenaiKeySection','draftOpenrouterKeySection','draftGoogleKeySection','draftPoeKeySection'].forEach(id => {
        document.getElementById(id).classList.add('d-none');
    });

    const keyMap = {openai:'draftOpenaiKeySection', openrouter:'draftOpenrouterKeySection', google:'draftGoogleKeySection', poe:'draftPoeKeySection'};
    if (keyMap[provider]) document.getElementById(keyMap[provider]).classList.remove('d-none');

    refreshDraftModels();
}

function handleCaptchaProviderChange() {
    const provider = document.querySelector('input[name="captcha_ai_provider"]:checked').value;

    document.querySelectorAll('#captchaProviderSelector .provider-pill').forEach(el => {
        el.classList.toggle('active', el.querySelector('input').value === provider);
    });

    ['captchaOpenaiKeySection','captchaOpenrouterKeySection','captchaGoogleKeySection','captchaPoeKeySection'].forEach(id => {
        document.getElementById(id).classList.add('d-none');
    });

    const keyMap = {openai:'captchaOpenaiKeySection', openrouter:'captchaOpenrouterKeySection', google:'captchaGoogleKeySection', poe:'captchaPoeKeySection'};
    if (keyMap[provider]) document.getElementById(keyMap[provider]).classList.remove('d-none');

    refreshCaptchaModels();
}

function handleTranslationProviderChange() {
    const provider = document.getElementById('translationProvider').value;
    const section = document.getElementById('translationModelSection');
    if (provider === 'google') {
        section.style.display = 'none';
    } else {
        section.style.display = 'block';
        refreshTranslationModels();
    }
}

/* ── Build model card HTML ── */
function buildModelCard(model, isSelected, targetInput) {
    const ctx = model.context_length ? `${(model.context_length / 1000).toFixed(0)}K` : '';
    const badges = [];
    if (model.reasoning) badges.push('<span class="model-badge model-badge-reasoning">Reasoning</span>');
    if (model.vision) badges.push('<span class="model-badge model-badge-vision">Vision</span>');
    if (model.tool_call) badges.push('<span class="model-badge model-badge-tools">Tools</span>');

    return `
        <div class="model-card ${isSelected ? 'model-card-selected' : ''}" onclick="selectModel('${targetInput}', '${model.id}', this)" title="${model.id}">
            <div class="model-card-name">${model.name || model.id}</div>
            <div class="model-card-meta">
                ${ctx ? `<span class="model-card-ctx">${ctx} ctx</span>` : ''}
            </div>
            <div class="model-card-badges">${badges.join('')}</div>
        </div>
    `;
}

function selectModel(inputId, modelId, cardEl) {
    document.getElementById(inputId).value = modelId;
    const grid = cardEl.closest('.model-cards-grid');
    grid.querySelectorAll('.model-card').forEach(c => c.classList.remove('model-card-selected'));
    cardEl.classList.add('model-card-selected');
}

/* ── Refresh models ── */
async function refreshDraftModels() {
    const provider = document.querySelector('input[name="draft_ai_provider"]:checked').value;
    await refreshModels(provider, 'draftModelList', 'draftModelHelp', 'draftModelSelect', 'draftModelCards', 'draftRefreshBtn');
}

async function refreshCaptchaModels() {
    const provider = document.querySelector('input[name="captcha_ai_provider"]:checked').value;
    await refreshModels(provider, 'captchaModelList', 'captchaModelHelp', 'captchaModelSelect', 'captchaModelCards', 'captchaRefreshBtn');
}

async function refreshTranslationModels() {
    const provider = document.querySelector('input[name="draft_ai_provider"]:checked').value;
    const datalist = document.getElementById('translationModelList');
    const helpText = document.getElementById('translationModelHelp');
    const input = document.getElementById('translationModelSelect');

    helpText.textContent = 'Loading...';
    input.disabled = true;

    try {
        const response = await fetch(`/api/models/${provider}`);
        const data = await response.json();
        datalist.innerHTML = '';
        if (data.models && data.models.length > 0) {
            data.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.label = model.name;
                datalist.appendChild(option);
            });
            helpText.textContent = `${data.models.length} models available`;
        } else {
            helpText.textContent = 'No models found. Uses default.';
        }
    } catch (error) {
        helpText.textContent = 'Error: ' + error.message;
    } finally {
        input.disabled = false;
    }
}

async function refreshModels(provider, datalistId, helpId, inputId, cardsId, refreshBtnId) {
    const datalist = document.getElementById(datalistId);
    const helpText = document.getElementById(helpId);
    const input = document.getElementById(inputId);
    const cardsContainer = document.getElementById(cardsId);
    const refreshBtn = document.getElementById(refreshBtnId);

    helpText.innerHTML = '<span class="shimmer-text shimmer-text-small">Loading models...</span>';
    input.disabled = true;
    if (refreshBtn) refreshBtn.disabled = true;

    cardsContainer.innerHTML = Array(4).fill('<div class="model-card-skeleton"></div>').join('');

    try {
        const response = await fetch(`/api/models/${provider}`);
        const data = await response.json();

        datalist.innerHTML = '';
        cardsContainer.innerHTML = '';

        if (data.models && data.models.length > 0) {
            const currentValue = input.value;
            const topModels = data.models.slice(0, 8);

            data.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                let label = model.name || model.id;
                if (model.context_length && model.context_length !== 'Unknown' && model.context_length > 0) {
                    label += ` (${parseInt(model.context_length).toLocaleString()} ctx)`;
                }
                if (model.reasoning) label += ' [Reasoning]';
                option.label = label;
                datalist.appendChild(option);
            });

            topModels.forEach(model => {
                const isSelected = model.id === currentValue;
                cardsContainer.innerHTML += buildModelCard(model, isSelected, inputId);
            });

            helpText.textContent = `${data.models.length} models available`;
        } else {
            helpText.textContent = 'No models found. Enter a custom model ID.';
        }
    } catch (error) {
        cardsContainer.innerHTML = '';
        helpText.textContent = 'Error: ' + error.message;
    } finally {
        input.disabled = false;
        if (refreshBtn) refreshBtn.disabled = false;
    }
}

function clearLocalStorage() {
    if (confirm("Log out and remove your API key from this browser?")) {
        localStorage.removeItem('moltbook_api_key');
        window.location.href = "{{ url_for('logout') }}";
    }
}

/* ── Init ── */
document.addEventListener('DOMContentLoaded', function() {
    refreshDraftModels();
    refreshCaptchaModels();
});
</script>
{% endblock %}
